(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-7e64dceb"],{"47e9":function(i,t,e){},8275:function(i,t,e){"use strict";e.r(t);var s=function(){var i=this,t=i.$createElement,e=i._self._c||t;return e("div",[e("van-nav-bar",{staticClass:"headBar fixedHeader",on:{"click-left":i.saveVisitDataThenGoBack}},[e("span",{staticClass:"icon iconfont icon-fanhui headBarIcon",attrs:{slot:"left"},slot:"left"}),e("span",{staticClass:"headBarTitle",attrs:{slot:"title"},slot:"title"},[i._v("拜访进行中...")]),e("span",{directives:[{name:"show",rawName:"v-show",value:!i.isBusyQuery&&i.currentVisit.Id,expression:"!isBusyQuery&&currentVisit.Id"}],staticClass:"icon iconfont icon-jieshu headBarIcon",attrs:{slot:"right"},on:{click:i.getGeolocationThenFinishVisit},slot:"right"})]),e("div",{staticClass:"content contentTop contentBottom",attrs:{id:"contentContainer"}},[e("crmLoading",{directives:[{name:"show",rawName:"v-show",value:i.isBusyQuery||i.isBusyFinish,expression:"isBusyQuery||isBusyFinish"}]}),e("div",{directives:[{name:"show",rawName:"v-show",value:!i.isBusyQuery&&i.currentVisit.Id,expression:"!isBusyQuery&&currentVisit.Id"}]},[e("van-cell-group",[e("van-field",{attrs:{label:"开始时间","left-icon":"icon iconfont icon-kaishishijian",readonly:""},model:{value:i.formatVisitBeginTime,callback:function(t){i.formatVisitBeginTime=t},expression:"formatVisitBeginTime"}}),e("van-field",{attrs:{label:"停留时长","left-icon":"icon iconfont icon-zengjiashichang",readonly:""},model:{value:i.visitDuration,callback:function(t){i.visitDuration=t},expression:"visitDuration"}})],1),e("van-cell-group",{staticStyle:{"margin-top":"8px"}},[e("van-field",{attrs:{label:"位置","left-icon":"icon iconfont icon-location",disabled:""},model:{value:i.currentVisit.BeginLocationDesc,callback:function(t){i.$set(i.currentVisit,"BeginLocationDesc",t)},expression:"currentVisit.BeginLocationDesc"}}),e("van-field",{attrs:{label:"客户名称","left-icon":"icon iconfont icon-client",disabled:""},model:{value:i.currentVisit.CustomerName,callback:function(t){i.$set(i.currentVisit,"CustomerName",t)},expression:"currentVisit.CustomerName"}})],1),e("van-cell-group",{staticStyle:{"margin-top":"8px"}},[e("van-field",{attrs:{label:"拜访人员",placeholder:"请输入拜访人员","input-align":"right",type:"textarea",autosize:"",rows:"1",required:""},model:{value:i.finishVisitInfo.VisitPerson,callback:function(t){i.$set(i.finishVisitInfo,"VisitPerson",t)},expression:"finishVisitInfo.VisitPerson"}}),e("van-field",{attrs:{label:"职务",placeholder:"请输入职务","input-align":"right",type:"textarea",autosize:"",rows:"1"},model:{value:i.finishVisitInfo.VisitPersonPost,callback:function(t){i.$set(i.finishVisitInfo,"VisitPersonPost",t)},expression:"finishVisitInfo.VisitPersonPost"}}),e("van-field",{attrs:{label:"联系方式",placeholder:"请输入联系方式","input-align":"right",type:"textarea",autosize:"",rows:"1"},model:{value:i.finishVisitInfo.VisitPersonPhone,callback:function(t){i.$set(i.finishVisitInfo,"VisitPersonPhone",t)},expression:"finishVisitInfo.VisitPersonPhone"}}),e("van-field",{attrs:{label:"同行人员",placeholder:"请输入同行人员","input-align":"right",type:"textarea",autosize:"",rows:"1"},model:{value:i.finishVisitInfo.PeerPerson,callback:function(t){i.$set(i.finishVisitInfo,"PeerPerson",t)},expression:"finishVisitInfo.PeerPerson "}}),e("van-field",{attrs:{label:"拜访内容",placeholder:"请输入拜访内容",type:"textarea",autosize:{maxHeight:160,minHeight:100},required:""},model:{value:i.finishVisitInfo.Content,callback:function(t){i.$set(i.finishVisitInfo,"Content",t)},expression:"finishVisitInfo.Content"}})],1)],1),e("crmPhoto",{directives:[{name:"show",rawName:"v-show",value:!i.isBusyQuery&&i.currentVisit.Id,expression:"!isBusyQuery&&currentVisit.Id"}],staticStyle:{"margin-top":"8px"},attrs:{imageCategory:"Visit",headerTitle:"拜访照片",readOnly:!1,allowPickAblum:!0,showHeader:!0,businessId:i.currentVisit.Id,customerName:i.currentVisit.CustomerName},on:{photoChange:i.onPhotoChange},model:{value:i.finishVisitInfo.PictureIds,callback:function(t){i.$set(i.finishVisitInfo,"PictureIds",t)},expression:"finishVisitInfo.PictureIds"}})],1),e("van-tabbar",{attrs:{zIndex:101}},[e("van-tabbar-item",{directives:[{name:"show",rawName:"v-show",value:!i.isBusyQuery&&i.currentVisit.Id,expression:"!isBusyQuery&&currentVisit.Id"}],staticClass:"bottomTabbarItem",on:{click:i.saveVisitData}},[e("span",{staticClass:"icon iconfont icon-Done",attrs:{slot:"icon"},slot:"icon"}),e("span",[i._v("保存信息")])]),e("van-tabbar-item",{directives:[{name:"show",rawName:"v-show",value:!i.isBusyQuery&&i.currentVisit.Id,expression:"!isBusyQuery&&currentVisit.Id"}],staticClass:"bottomTabbarItem",on:{click:i.getGeolocationThenFinishVisit}},[e("span",{staticClass:"icon iconfont icon-jieshu",attrs:{slot:"icon"},slot:"icon"}),e("span",[i._v("结束拜访")])])],1)],1)},n=[],o=(e("a481"),e("c665")),a=e("dc0a"),r=e("aa9a"),c=e("d328"),u=e("11d9"),l=e("9ab4"),h=e("2b0e"),f=e("60a3"),d=e("b970"),V=e("2b67"),v=e("5b69"),m=e("3cda"),I=e("9290"),g=e("46c4"),y=e("9bae"),p=function(i){function t(){var i;return Object(o["a"])(this,t),i=Object(c["a"])(this,Object(u["a"])(t).apply(this,arguments)),i.currentPersonId="",i.currentVisitId=null,i.currentVisit={},i.visitBeginTime=null,i.timer=null,i.formatVisitBeginTime="",i.visitDuration="",i.isBusyQuery=!1,i.isBusyFinish=!1,i.finishVisitInfo={FinishLongitude:"",FinishLatitude:"",FinishLocationDesc:"",VisitPerson:"",VisitPersonPost:"",VisitPersonPhone:"",PeerPerson:"",Content:"",PictureIds:[]},i}return Object(r["a"])(t,[{key:"onEnter",value:function(){if(this.currentPersonId=V["a"].instance.getPersonId(),this.currentVisitId=this.$route.query.newVisitId,!this.currentVisitId)return g["a"].toastMessage("没有拜访信息"),void this.goBack();this.queryCurrentVisit()}},{key:"beforeRouteEnter",value:function(i,t,e){e(function(i){i.onEnter()})}},{key:"queryCurrentVisit",value:function(){var i=this;this.isBusyQuery=!0,this.$Api.invoke({moduleName:"crm.visit.visitService",className:"VisitService",method:"getById",args:{id:this.currentVisitId}}).then(function(t){t.data&&t.data.isSuccess?i.queryCurrentVisitSuccess(t):g["a"].toastMessage("查询拜访数据失败!"+t.data.error),console.log(t)}).catch(function(i){g["a"].toastMessage("查询拜访数据异常!"+i),console.log(i)}).finally(function(){i.isBusyQuery=!1})}},{key:"queryCurrentVisitSuccess",value:function(i){var t=this;i.data.data.IsVisiting?(this.currentVisit=i.data.data,this.currentVisit.PictureIds||(this.currentVisit.PictureIds=[]),this.initFinishVisitInfo(i.data.data),this.formatVisitBeginTime=I["a"].formatDateTime(this.currentVisit.CreateTime,"yyyy-MM-dd hh:mm:ss"),this.startComputeDurationTimer()):g["a"].dialogAlert("提示","当前的拜访已结束!").then(function(){t.goBack()})}},{key:"initFinishVisitInfo",value:function(i){this.finishVisitInfo.VisitPerson=i.VisitPerson,this.finishVisitInfo.VisitPersonPost=i.VisitPersonPost,this.finishVisitInfo.VisitPersonPhone=i.VisitPersonPhone,this.finishVisitInfo.PeerPerson=i.PeerPerson,this.finishVisitInfo.Content=i.Content,this.finishVisitInfo.PictureIds=i.PictureIds}},{key:"startComputeDurationTimer",value:function(){var i=this;this.visitBeginTime=new Date(this.currentVisit.CreateTime),this.visitDuration=this.computeVisitDuration(this.visitBeginTime),this.timer=setInterval(function(){i.visitDuration=i.computeVisitDuration(i.visitBeginTime)},1e3)}},{key:"computeVisitDuration",value:function(i){var t=new Date,e=t.getTime()-i.getTime();if(e<0)return"00时00分00秒";var s=Math.floor(e/1e3),n=Math.floor(s/3600),o=Math.floor((s-3600*n)/60),a=s-3600*n-60*o;return n+"时"+o+"分"+a+"秒"}},{key:"destroyed",value:function(){this.timer&&(clearInterval(this.timer),this.timer=null)}},{key:"saveVisitData",value:function(){this.saveVisitDataPromise().then(function(i){g["a"].toastMessage("已保存")}).catch(function(i){console.log(i)})}},{key:"saveVisitDataThenGoBack",value:function(){var i=this;d["b"].loading({duration:0,forbidClick:!0,message:"正在保存..."});this.saveVisitDataPromise().then(function(t){d["b"].clear(),i.goBack()}).catch(function(i){d["b"].clear(),console.log(i)})}},{key:"onPhotoChange",value:function(){this.saveVisitDataPromise().then(function(i){console.log("已保存")}).catch(function(i){console.log(i)})}},{key:"saveVisitDataPromise",value:function(){var i=this;return new Promise(function(t,e){i.$Api.invoke({moduleName:"crm.visit.visitService",className:"VisitService",method:"saveVisitData",args:{personId:i.currentPersonId,visitId:i.currentVisitId,visitData:i.finishVisitInfo}}).then(function(i){i.data&&i.data.isSuccess?t(!0):(g["a"].toastMessage("保存拜访数据失败!"+i.data.error),e(!1))}).catch(function(i){g["a"].toastMessage("保存拜访数据异常!"+i),e(!1)}).finally(function(){})})}},{key:"getGeolocationThenFinishVisit",value:function(){var i=this;this.checkFinishVisitInfo()&&v["a"].getGeolocation().then(function(t){i.finishVisitInfo.FinishLongitude=t.point.lng,i.finishVisitInfo.FinishLatitude=t.point.lat,i.finishVisitInfo.FinishLocationDesc=v["a"].generateAddressDesc(t.address),i.finishVisit()}).catch(function(t){console.log(t),i.finishVisit()})}},{key:"finishVisit",value:function(){var i=this;this.isBusyFinish=!0,this.$Api.invoke({moduleName:"crm.visit.visitService",className:"VisitService",method:"finishVisit",args:{personId:this.currentPersonId,visitId:this.currentVisitId,finishData:this.finishVisitInfo}}).then(function(t){t.data&&t.data.isSuccess?(i.notifyFinishCurrentVisit(),i.goVisitCompleted()):g["a"].toastMessage("结束拜访失败!"+t.data.error),console.log(t)}).catch(function(i){g["a"].toastMessage("结束拜访异常!"+i),console.log(i)}).finally(function(){i.isBusyFinish=!1})}},{key:"notifyFinishCurrentVisit",value:function(){this.$store.commit("removeCurrentVisitId")}},{key:"checkFinishVisitInfo",value:function(){return this.currentPersonId?this.currentVisitId&&this.currentVisit.Id?this.finishVisitInfo.VisitPerson?!!this.finishVisitInfo.Content||(g["a"].toastMessage("请输入拜访内容!"),!1):(g["a"].toastMessage("请输入拜访人!"),!1):(g["a"].toastMessage("未查到当前拜访数据!"),!1):(g["a"].toastMessage("未能确定您的登录信息,请退出重新登录!"),!1)}},{key:"goBack",value:function(){this.$router.back()}},{key:"goVisitCompleted",value:function(){this.$router.replace({path:"/visitCompleted",query:{visitId:this.currentVisitId,customerId:this.currentVisit.CustomerId,customerName:this.currentVisit.CustomerName}})}}]),Object(a["a"])(t,i),t}(h["default"]);p=l["a"]([Object(f["a"])({components:{crmLoading:m["a"],crmPhoto:y["a"]}})],p);var P=p,b=P,k=b,B=(e("edae"),e("2877")),C=Object(B["a"])(k,s,n,!1,null,"009a92e7",null);C.options.__file="createVisit.vue";t["default"]=C.exports},edae:function(i,t,e){"use strict";var s=e("47e9"),n=e.n(s);n.a}}]);